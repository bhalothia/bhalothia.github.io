---
layout: post
title: Using mdadm to learn RAID concepts
date: '2012-03-04T22:26:00.034+05:30'
author: Saurabh
tags: 
- raid
- devops
modified_time: '2012-03-05T00:22:44.136+05:30'
blogger_id: tag:blogger.com,1999:blog-590496507799049344.post-4118995537475451661
blogger_orig_url: http://curiosityhealsthecat.blogspot.com/2012/03/using-mdadm-to-learn-raid-concepts.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">I've been using <a href="http://linux.die.net/man/8/mdadm" target="_blank">mdadm</a> to learn about software <a href="http://en.wikipedia.org/wiki/RAID" target="_blank">RAID</a> configurations on Linux and I find it to be a great resource to play around with and do some hands on work. How I wish we were taught using these tools in college, rather than just being bombarded by all possible combinations of RAID.<br /><br />Having the ability to setup and tear down VMs at the snap of a finger makes me think how fortunate CS students are nowadays. We had it tough. At the risk of digression, I sound like one of the Yorkshiremen from the classic Monty Python sketch - <a href="http://www.youtube.com/watch?v=Xe1a1wHxTyo" target="_blank">The Four Yorkshiremen</a><br /><br />Statistics have shown that 85% of the audience, after clicking the above link have spent at least 45 minutes visiting the various sketches of Monty Python, including, but not limited to - <a href="http://www.youtube.com/watch?v=-gwXJsWHupg" target="_blank">Woody and tinny words</a>, <a href="http://www.youtube.com/watch?v=kQFKtI6gn9Y" target="_blank">Argument Clinic</a> and others.<br /><br />And.... we are back..<br /><br /><a href="https://raid.wiki.kernel.org/" target="_blank">This</a> tutorial gives a gentle introduction to RAID and then builds up on the concepts and walks the reader through the mdadm tool. As that HOWTO is already delivering, I will not go into the details of it. The aim of this post is to inform about the pre-requisite setup for building RAIDs.<br /><br />I am using <a href="https://www.virtualbox.org/" target="_blank">Virtualbox</a> with a VM running Ubuntu 10.10. For mdadm I have installed the mdadm tool (installation steps mentioned in the tutorial page).<br /><br />As you are going to play with different RAID configurations, you will need to add multiple disks. For VirtualBox, go to the main menu, right click on the VM, go to settings and then to storage. Out there add 2 more SATA disks each of 1 GB - I used this value because I am going to partition each disk into 2 partitions of 512 MB each. If there are no new disks added to your system, then these disks will show up as /dev/sdb and /dev/sdc on your Linux box.<br /><br />Boot up your VM. Become root. Execute the following command:<br /><pre class="shell" name="code"># fdisk -l<br /></pre>You will see a partition table for /dev/sda -  containing - /dev/sda1, /dev/sda2, etc. - this is the first disk in which your OS is installed. We are not going to touch this disk.<br /><br />We are going to work with /dev/sdb and /dev/sdc - the 2 new disks that have been added. If you already had added other disks the device names may be different in your case - but one thing is for sure - for the new disks, the partition table will not exist. Hence for the new ones fdisk output will be something like this:<br /><a name='more'></a><br /><pre class="shell" name="code">Disk /dev/sdb: 1073 MB, 1073741824 bytes<br />255 heads, 63 sectors/track, 130 cylinders<br />Units = cylinders of 16065 * 512 = 8225280 bytes<br />Sector size (logical/physical): 512 bytes / 512 bytes<br />I/O size (minimum/optimal): 512 bytes / 512 bytes<br />Disk identifier: 0x00000000<br />Disk /dev/sdb doesn't contain a valid partition table<br /></pre>As mentioned earlier, the new disks will not contain any partition tables - which is visible in the above output.<br /><br />Please make sure that you use the new disks. If you follow the steps below without knowing which partition you are working on, then you sir are not only shooting yourself in the foot, you are blowing the brains out of your VM also in the process.<br /><br />So in this case, I am <b>assuming</b> (notice the bold font, imagine the font size to be 20, font color to be a gory red, and the word being animated to flash every other second) that you added 2 new disks to your system: /dev/sdb and /dev/sdc - both of size 1 GB. Verify that the partition table does not exist by doing:<br /><pre class="shell" name="code"># fdisk -l /dev/sdb<br /></pre>and<br /><pre class="shell" name="code"># fdisk -l /dev/sdc<br /></pre>should say "Disk /dev/sdx does not contain valid partition table"<br /><br />Follow these steps to create the partition tables:<br /><ol><li> Create partition table for /dev/sdb - create 2 partitions of 512 MB each</li><pre class="shell" name="code"># fdisk /dev/sdb<br />Command (m for help): n<br />Command action<br />e extended<br />p primary partition (1-4)<br />p<br /><br />Partition number (1-4): 1<br />First cylinder (1-130, default 1):<br />Using default value 1<br />Last cylinder, +cylinders or +size{K,M,G} (1-130, default 130): +512M<br /><br />Command (m for help): n<br />Command action<br />e extended<br />p primary partition (1-4)<br />p<br /><br />Partition number (1-4): 2<br />First cylinder (67-130, default 67):<br />Using default value 67<br />Last cylinder, +cylinders or +size{K,M,G} (67-130, default 130):<br />Using default value 130<br /><br />Command (m for help): w<br />The partition table has been altered!<br /><br />Calling ioctl() to re-read partition table.<br />Syncing disks.<br /></pre><li> Verify the paritions created</li><pre class="shell" name="code"># fdisk -l /dev/sdb<br /><br />Device Boot      Start         End      Blocks   Id  System<br />/dev/sdb1               1          66      530113+  83  Linux<br />/dev/sdb2              67         130      514080   83  Linux<br /></pre><li> Follow steps 1 and 2 with /dev/sdc instead of /dev/sdb</li></ol>That's all you need to start and playing with mdadm. Click <a href="https://raid.wiki.kernel.org/articles/r/a/i/RAID_setup_cbb2.html" target="_blank">here</a> to let the games begin. <br /><br />The really cool part of mdadm is that you can actually set one of the disk as "faulty" then in case of RAID - 1 (which does mirroring without any striping), use the primary disk and remove the faulty one.  For the sake of completeness, I am going to dump the steps I followed to create a simple RAID 1 setup using /dev/sdc1 and /dev/sdc2.<br /><ol><li> Create a RAID 1 setup using /dev/sdc1 and /dev/sdc2. Remember that /dev/md0 is a device created by combining /dev/sdc1 and /dev/sdc2 - you cannot mount these partitions individually. <br /></li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --create --verbose /dev/md0 --level=mirror --raid-devices=2 /dev/sdc1 /dev/sdc2<br />mdadm: size set to 513984K<br />mdadm: largest drive (/dev/sdc1) exceed size (513984K) by more than 1%<br />Continue creating array? y<br />mdadm: array /dev/md0 started.<br /></pre><li> Create an ext3 filesystem on the device /dev/md0</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mke2fs -j /dev/md0<br /></pre><li> Mount the device</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mount /dev/md0 /mnt/<br /></pre><li>Check the disk status</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | tail -3 # you should remove tail to see more output<br /><br />    Number   Major   Minor   RaidDevice State<br />       0       8       33        0      active sync   /dev/sdc1<br />       1       8       34        1      active sync   /dev/sdc2<br /></pre><li> Set one of the disks faulty. Before doing this keep a separate tab open with the command:</li><pre name="code">root@vm1-ubuntu:/var/tmp# tail -f /var/log/kern.log<br /></pre><li> Do it</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --manage --set-faulty /dev/md0 /dev/sdc2 <br />mdadm: set /dev/sdc2 faulty in /dev/md0<br /></pre><li> At this point my kernel log shows the message: </li><pre class="shell" name="code">md/raid1:md0: Disk failure on sdc2, disabling device.<br /></pre><li> Check the mdadm output</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0  | tail -5 <br />    Number   Major   Minor   RaidDevice State<br />       0       8       33        0      active sync   /dev/sdc1<br />       1       0        0        1      removed<br /><br />       2       8       34        -      faulty spare   /dev/sdc2<br /></pre><li> Remove the faulty disk.</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm /dev/md0 -r /dev/sdc2 <br />mdadm: hot removed /dev/sdc2<br /></pre><li> Check the details once again:</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | tail -3<br /><br />    Number   Major   Minor   RaidDevice State<br />       0       8       33        0      active sync   /dev/sdc1<br />       1       0        0        1      removed<br /></pre><li> Add the new disk again. Re-adding the same disk - as if it was a new one.</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm /dev/md0 -a /dev/sdc2 <br />mdadm: re-added /dev/sdc2<br /></pre><li> At this point, the new disk will be rebuilt with the data from the working disk.</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | grep -i rebuild <br />Rebuild Status : 1% complete<br /><br />root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | grep -i rebuild <br />Rebuild Status : 53% complete<br /><br />root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | grep -i rebuild <br />Rebuild Status : 94% complete<br /><br />root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | grep -i rebuild <br /># above command gave no output =&gt; check the disk states to verify if rebuild done<br /></pre><li> Check the details once again. Now that the new second disk is rebuilt, both will be in active sync.</li><pre class="shell" name="code">root@vm1-ubuntu:/var/tmp# mdadm --detail /dev/md0 | tail -3  <br />    Number   Major   Minor   RaidDevice State<br />       0       8       33        0      active sync   /dev/sdc1<br />       1       8       34        1      active sync   /dev/sdc2<br /></pre></ol></div>
